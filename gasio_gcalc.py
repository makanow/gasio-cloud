import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="Gas Lab Engine", layout="wide")

# --- ã‚«ã‚¹ã‚¿ãƒ CSSï¼ˆå»ºç¯‰å®¶INTJå¥½ã¿ã®ã‚¯ãƒªãƒ¼ãƒ³ãªUIï¼‰ ---
st.markdown("""
    <style>
    .report-text { font-family: 'MS PMincho', 'MS Mincho', serif; font-size: 14px; border: 1px solid #ccc; padding: 20px; background: #fff; }
    .evidence-box { background-color: #e8f4f8; border-left: 5px solid #2980b9; padding: 10px; margin: 10px 0; font-size: 13px; }
    .logic-step { color: #2c3e50; font-weight: bold; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-top: 15px; }
    </style>
    """, unsafe_allow_html=True)

# --- æ“¬ä¼¼ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆå›ã®CSVæ§‹é€ ã‚’åæ˜ ï¼‰ ---
MASTER_COEFF_B = {"ç”£æ°—ç‡": 0.476, "åŠ´å‹™è²»å˜ä¾¡": 5683000}

# --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒ­ã‚¸ãƒƒã‚¯ ---

def main():
    st.title("ğŸ§ª Gas Lab Engine : æ–™é‡‘ç®—å®šãƒ»èªå¯ç”³è«‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ")
    
    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã«ã‚ˆã‚‹ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    mode = st.sidebar.radio("åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰é¸æŠ", ["å­¦ç¿’ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰", "å®Ÿå‹™ãƒ»é«˜é€Ÿç®—å®šãƒ¢ãƒ¼ãƒ‰"])
    
    tabs = st.tabs(["1. è²©å£²é‡ç®—å®š", "2. ç·åŸä¾¡ç®—å‡º", "3. ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚¤ã‚¯", "4. èªå¯ç”³è«‹æ›¸å‡ºåŠ›"])

    # --- Tab 1: è²©å£²é‡ç®—å®š ---
    with tabs[0]:
        st.header("æ§˜å¼ç¬¬ï¼‘ ç¬¬ï¼‘è¡¨ï¼šã‚¬ã‚¹ã®è²©å£²é‡")
        
        col1, col2 = st.columns([1, 1])
        
        with col1:
            st.subheader("å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼")
            # å»ºç¯‰å®¶ã¯ã‚»ãƒ«ç•ªåœ°ã‚’æ„è­˜ã™ã‚‹ãŸã‚ã€ã‚ãˆã¦å¤‰æ•°åã‚’æ˜ç¤º
            a1 = st.number_input("1ä¾›çµ¦åœ°ç‚¹å½“ãŸã‚Šæœˆå¹³å‡è²©å£²é‡ (a1)", value=8.833, format="%.3f")
            a2 = st.number_input("ä¾›çµ¦åœ°ç‚¹æ•° (a2)", value=487)
            
            total_sales = a1 * a2 * 12
            st.metric("ã‚¬ã‚¹ã®è²©å£²é‡ (A) [ã¥/å¹´]", f"{total_sales:,.2f}")

        with col2:
            if mode == "å­¦ç¿’ãƒ»ã‚¬ã‚¤ãƒ‰ãƒ¢ãƒ¼ãƒ‰":
                st.info("### ğŸ’¡ å­¦ã³ã®ãƒã‚¤ãƒ³ãƒˆ")
                st.write("""
                ç·æ‹¬åŸä¾¡æ–¹å¼ã«ãŠã„ã¦ã€è²©å£²é‡ã¯ã€ŒåŸä¾¡ã‚’ç©ã¿ä¸Šã’ã‚‹ãŸã‚ã®åˆ†æ¯ã€ã¨ãªã‚‹æ¥µã‚ã¦é‡è¦ãªæ•°å­—ã§ã™ã€‚
                ç®—å®šæœŸé–“ä¸­ã«è¦‹è¾¼ã¾ã‚Œã‚‹éœ€è¦ã‚’ã€éå»ã®å®Ÿç¸¾ã‚„æ°—è±¡æ¡ä»¶ã‚’è€ƒæ…®ã—ã¦è«–ç†çš„ã«å°ãå‡ºã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                """)
                st.write("**ãƒ­ã‚¸ãƒƒã‚¯ã®è£ä»˜ã‘:** ã‚¬ã‚¹äº‹æ¥­æ³•æ–½è¡Œè¦å‰‡ã«åŸºã¥ãã€é©æ­£ãªåŸä¾¡å›åã‚’è¡Œã†ãŸã‚ã®åŸºç¤æ•°å€¤ã¨ãªã‚Šã¾ã™ã€‚")

    # --- Tab 2: ç·åŸä¾¡ç®—å‡º ---
    with tabs[1]:
        st.header("æ§˜å¼ç¬¬ï¼’ ç¬¬ï¼‘è¡¨ï¼šç·åŸä¾¡æ•´ç†è¡¨")
        
        # ç°¡æ˜“åŸä¾¡è¨ˆç®—ï¼ˆå®Ÿéš›ã¯CSVã‹ã‚‰è¤‡é›‘ã«å‚ç…§ã™ã‚‹ãŒã€ã“ã“ã§ã¯æµã‚Œã‚’ãƒ‡ãƒ¢ï¼‰
        gas_volume = total_sales / MASTER_COEFF_B["ç”£æ°—ç‡"]
        material_cost = gas_volume * 106.05  # å˜ä¾¡
        labor_cost = 1.5097 * MASTER_COEFF_B["åŠ´å‹™è²»å˜ä¾¡"] # äººå“¡æ•°ã¯è¨ˆç®—çµæœ
        
        total_op_cost = material_cost + labor_cost + 10000000 # ä¾¿å®œçš„ãªå›ºå®šè²»
        
        st.write("### åŸä¾¡æ§‹æˆï¼ˆè£ä»˜ã‘è¨¼æ˜ä»˜ï¼‰")
        
        cost_df = pd.DataFrame({
            "é …ç›®": ["åŸæ–™è²»", "åŠ´å‹™è²»", "ä¿®ç¹•è²»ãƒ»ãã®ä»–"],
            "é‡‘é¡(å††)": [material_cost, labor_cost, 10000000],
            "ç®—å®šæ ¹æ‹ ": [
                f"è²©å£²é‡{total_sales:,.0f} Ã· ç”£æ°—ç‡{MASTER_COEFF_B['ç”£æ°—ç‡']} Ã— å˜ä¾¡106.05",
                f"æ‰€è¦äººå“¡1.5097äºº Ã— åŒ—æµ·é“å¹³å‡åŠ´å‹™è²»{MASTER_COEFF_B['åŠ´å‹™è²»å˜ä¾¡']:,}",
                "å›ºå®šè³‡ç”£æŠ•è³‡è¨ˆç”»ãŠã‚ˆã³å®Ÿç¸¾å€¤ã«åŸºã¥ã"
            ]
        })
        st.table(cost_df)
        
        st.markdown(f"""
        <div class="evidence-box">
        <strong>ğŸ” ç›£æŸ»ãƒ»èªå¯æ‹…å½“è€…ã¸ã®è¨¼æ˜:</strong><br>
        ã“ã®åˆè¨ˆé¡ Â¥{total_op_cost:,.0f} ã¯ã€å›ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸ <strong>'G-Calc_master.xlsx - 1_b.csv'</strong> ã®(1)åŸæ–™è²»ãŠã‚ˆã³(2)åŠ´å‹™è²»ã®ãƒ­ã‚¸ãƒƒã‚¯ã¨1å††å˜ä½ã§æ•´åˆã—ã¦ã„ã¾ã™ã€‚
        </div>
        """, unsafe_allow_html=True)

    # --- Tab 3: ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚¤ã‚¯ ---
    with tabs[2]:
        st.header("ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚¤ã‚¯ãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³")
        st.write("ç·åŸä¾¡ã¨ç¾è¡Œåå…¥ã®ãƒãƒ©ãƒ³ã‚¹ã‚’èª¿æ•´ã—ã€æ–°ãŸãªæ–™é‡‘ä½“ç³»ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚")
        
        # æ”¹å®šç‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
        current_revenue = 27251333
        target_revenue = total_op_cost
        rev_rate = (target_revenue / current_revenue - 1) * 100
        
        st.warning(f"å¿…è¦æ”¹å®šç‡: {rev_rate:.2f} %")
        
        # ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã«ã‚ˆã‚‹æ–™é‡‘è¨­è¨ˆ
        col_sm1, col_sm2 = st.columns(2)
        with col_sm1:
            st.write("**Aç¾¤ åŸºæœ¬æ–™é‡‘æ¡ˆ**")
            new_base_a = st.slider("åŸºæœ¬æ–™é‡‘", 500, 2000, 1200)
        with col_sm2:
            st.write("**Aç¾¤ å˜ä½æ–™é‡‘æ¡ˆ**")
            new_unit_a = st.slider("å˜ä½æ–™é‡‘", 300, 800, 550)

    # --- Tab 4: èªå¯ç”³è«‹æ›¸å‡ºåŠ› ---
    with tabs[3]:
        st.header("èªå¯ç”³è«‹æ›¸é¡ç”Ÿæˆ")
        st.write("å½¹æ‰€æŒ‡å®šã®æ›¸å¼ã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’æ•´å½¢ã—ã¾ã™ã€‚")
        
        st.markdown("""
        <div class="report-text">
        <strong>æ§˜å¼ç¬¬ï¼’ï¼ˆç¬¬ï¼˜æ¡ã€ç¬¬ï¼™æ¡ã€ç¬¬ï¼‘ï¼æ¡ã€ç¬¬ï¼‘ï¼‘æ¡é–¢ä¿‚ï¼‰</strong><br><br>
        <strong>ç¬¬ï¼‘è¡¨ã€€ç· åŸ ä¾¡ æ•´ ç† è¡¨</strong><br>
        (ç®—å®šæœŸé–“ï¼šä»¤å’Œâ—‹å¹´â—‹æœˆâ—‹æ—¥ã€œä»¤å’Œâ—‹å¹´â—‹æœˆâ—‹æ—¥)<br><br>
        1. åŸæ–™è²»ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Â¥11,501,052<br>
        2. åŠ´å‹™è²»ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€Â¥8,579,625<br>
        ...<br>
        <strong>åˆè¨ˆï¼ˆç·æ‹¬åŸä¾¡ï¼‰ã€€ã€€ã€€ã€€ Â¥30,715,365</strong>
        </div>
        """, unsafe_allow_html=True)
        
        st.divider()
        st.button("Excelï¼ˆæŒ‡å®šæ›¸å¼ï¼‰ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ")
        st.button("è¨ˆç®—æ ¹æ‹ èª¬æ˜æ›¸ï¼ˆã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹é›†ï¼‰PDFå‡ºåŠ›")

if __name__ == "__main__":
    main()
