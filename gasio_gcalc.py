import streamlit as st
import pandas as pd

# ---------------------------------------------------------
# 1. åˆæœŸè¨­å®š
# ---------------------------------------------------------
st.set_page_config(page_title="G-Calc PoC", layout="wide")
st.title("ğŸ›¡ï¸ G-Calc ãƒ‘ã‚¤ãƒ­ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼šåŠ´å‹™è²»ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ç®—å®š")

# ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆGitHubä¸Šã®Excelãƒ•ã‚¡ã‚¤ãƒ«åã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
EXCEL_FILE = "G-Calc_master.xlsx"

@st.cache_data
def load_excel_data():
    try:
        # Excelã®ã€ŒãƒŠãƒ“ã€ã‚·ãƒ¼ãƒˆã‹ã‚‰åŸºæœ¬æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
        df_nav = pd.read_excel(EXCEL_FILE, sheet_name='ãƒŠãƒ“', header=None)
        # B13ã‚»ãƒ«ï¼ˆ12è¡Œç›®ã€1åˆ—ç›®ï¼‰ã‚ãŸã‚Šã«åœ°ç‚¹æ•°ãŒã‚ã‚‹ã¨ä»®å®š
        # â€»å®Ÿéš›ã®åº§æ¨™ã«åˆã‚ã›ã¦å¾®èª¿æ•´ãŒå¿…è¦
        cust_count = df_nav.iloc[12, 4] 
        return float(cust_count)
    except Exception as e:
        st.error(f"Excelèª­ã¿è¾¼ã¿å¤±æ•—ï¼š{e}")
        return 245.0 # ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤

# ---------------------------------------------------------
# 2. å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³
# ---------------------------------------------------------
st.header("ğŸ® ç®—å®šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼")
base_cust_count = load_excel_data()

col1, col2 = st.columns(2)

with col1:
    st.subheader("ğŸ“ å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿")
    customer_count = st.number_input("ä¾›çµ¦åœ°ç‚¹æ•° (Excelã‹ã‚‰å–å¾—)", value=base_cust_count)
    std_coeff = 0.0031  # æœ¬æ¥ã¯æ¨™æº–ä¿‚æ•°ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—
    avg_wage = 7104000  # æœ¬æ¥ã¯åŠ´å‹™è²»ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—

    st.divider()
    # ã€é‡è¦ã€‘ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å…¥åŠ›ã®åˆ‡ã‚Šæ›¿ãˆ
    calc_mode = st.radio("åŠ´å‹™è²»ã®æ¡ç”¨ãƒ­ã‚¸ãƒƒã‚¯", ["ç†è«–è¨ˆç®—å€¤ï¼ˆæ¨™æº–ä¿‚æ•°ï¼‰", "å®Ÿç¸¾å€¤ï¼ˆæ‰‹å…¥åŠ›ï¼‰"])
    
    if calc_mode == "å®Ÿç¸¾å€¤ï¼ˆæ‰‹å…¥åŠ›ï¼‰":
        manual_labor_cost = st.number_input("å®Ÿç¸¾åŠ´å‹™è²»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (å††)", value=5500000)
    else:
        # ç†è«–å€¤ã®è¨ˆç®—
        theory_labor_cost = customer_count * std_coeff * avg_wage
        st.info(f"è¨ˆç®—å¼: {customer_count}åœ°ç‚¹ Ã— {std_coeff} Ã— {avg_wage:,.0f}å††")

with col2:
    st.subheader("ğŸ’¡ ç®—å®šçµæœãƒ»æ ¹æ‹ ")
    
    if calc_mode == "å®Ÿç¸¾å€¤ï¼ˆæ‰‹å…¥åŠ›ï¼‰":
        final_cost = manual_labor_cost
        st.warning("âš ï¸ ç¾åœ¨ã€å®Ÿç¸¾å€¤ã€‘ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚")
    else:
        final_cost = theory_labor_cost
        st.success("âœ… ç¾åœ¨ã€ç†è«–è¨ˆç®—å€¤ã€‘ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚")

    st.metric("æ¡ç”¨ã•ã‚Œã‚‹åŠ´å‹™è²»", f"{final_cost:,.0f} å††")

# ---------------------------------------------------------
# 3. ãƒ­ã‚¸ãƒƒã‚¯å…¬é–‹ãƒ¢ãƒ¼ãƒ‰
# ---------------------------------------------------------
st.divider()
if st.checkbox("ğŸ“– ãƒ­ã‚¸ãƒƒã‚¯å…¬é–‹ãƒ¢ãƒ¼ãƒ‰ï¼ˆå½¹æ‰€å¯©æŸ»ãƒ»æ•™è‚²ç”¨ï¼‰"):
    st.markdown("### åŠ´å‹™è²»ç®—å®šã®æ ¹æ‹ ")
    if calc_mode == "ç†è«–è¨ˆç®—å€¤ï¼ˆæ¨™æº–ä¿‚æ•°ï¼‰":
        st.write("æœ¬æ•°å€¤ã¯ã€ã‚¬ã‚¹äº‹æ¥­è¨±å¯ç”³è«‹ç­‰ã«åŸºã¥ãæ¨™æº–ä¿‚æ•°ã‚’ç”¨ã„ã¦ç®—å‡ºã•ã‚Œã¦ã„ã¾ã™ã€‚")
        st.latex(r"Cost = \text{åœ°ç‚¹æ•°} \times \text{æ¨™æº–ä¿‚æ•°} \times \text{å¹³å‡è³ƒé‡‘}")
    else:
        st.write("æœ¬æ•°å€¤ã¯ã€ç›´è¿‘3å¹´é–“ã®æ±ºç®—å®Ÿç¸¾å¹³å‡ã«åŸºã¥ãã€å®Ÿæ…‹ã«å³ã—ã¦ç®—å®šã•ã‚Œã¦ã„ã¾ã™ã€‚")
        st.info("æ ¹æ‹ è³‡æ–™ï¼š2023-2025å¹´åº¦ æ±ºç®—å ±å‘Šæ›¸ åŠ´å‹™è²»æ˜ç´°å‚ç…§")
